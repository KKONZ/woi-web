<div id="event-tables" class="tab-pane fade in active">
    <h3>Teams</h3>
    <div class="row datatable">
        <div class="col-sm-12">
            <table class="table dataTable table-striped no-footer nowrap" role="grid" cellspacing="0" width="100%" style="width: 100%;">
                <thead>
                    <tr>
                        <th class="left-rounded">Team</th>
                        <th>GF</th>
                        <th>SF</th>
                        <th>MSF</th>
                        <th>BSF</th>
                        <th>CF</th>
                        <th>SCF</th>
                        <th>HSCF</th>
                        <th>ZSO</th>
                        <th>HIT</th>
                        <th>PN</th>
                        <th>FO_W</th>
                        <th>TOI</th>
                    </tr>
                </thead>
                <tbody>
                    {% for teamrun in teamrun %}
                    <tr>
                        <td><img alt="{{ teamrun["Team"] }} Logo" src="{{ url_for('static', filename='img/team/' + teamrun["Team"] + '.png') }}" height="20" width="20"/>{{ teamrun["Team"]|teamshortname }}</td>
                        <td>{{ teamrun["GF"] }}</td>
                        <td>{{ teamrun["SF"]|int }}</td>
                        <td>{{ teamrun["MSF"]|int }}</td>
                        <td>{{ teamrun["BSF"]|int }}</td>
                        <td>{{ teamrun["CF"]|int }}</td>
                        <td>{{ teamrun["SCF"] }}</td>
                        <td>{{ teamrun["sSCF"] }}</td>
                        <td>{{ teamrun["ZSO"] }}</td>
                        <td>{{ teamrun["HIT"] }}</td>
                        <td>{{ teamrun["PENL_TAKEN"] }}</td>
                        <td>{{ teamrun["FAC_WIN"] }}</td>
                        <td>{{ teamrun["TOI"]|calc_toi }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

        </div>
    </div>
    <h3>Goalies</h3>
    <div class="row datatable">
        <div class="col-sm-12">
            <table class="table dataTable hover stripe order-column no-footer nowrap" role="grid" cellspacing="0" width="100%" style="width: 100%;">
                <thead>
                    <tr>
                        <th class="left-rounded">Name</th>
                        <th>Team</th>
                        <th>GU</th>
                        <th>SU</th>
                        <th>G.L</th>
                        <th>S.L</th>
                        <th>G.M</th>
                        <th>S.M</th>
                        <th>G.H</th>
                        <th>S.H</th>
                        <th>TOI</th>
                    </tr>
                </thead>
                <tbody>
                    {% for goalie in goalies %}
                    <tr>
                        <td>{{ woiid[goalie["ID"]].full_name }}</td>
                        <td><img alt="{{ goalie["Team"] }} Logo" src="{{ url_for('static', filename='img/team/' + goalie["Team"] + '.png') }}" height="20" width="20"/>{{ goalie["Team"]|teamshortname }}</td>
                        <td>{{ goalie["gu"] }}</td>
                        <td>{{ goalie["su"] }}</td>
                        <td>{{ goalie["gl"] }}</td>
                        <td>{{ goalie["sl"] }}</td>
                        <td>{{ goalie["gm"] }}</td>
                        <td>{{ goalie["sm"] }}</td>
                        <td>{{ goalie["gh"] }}</td>
                        <td>{{ goalie["sh"] }}</td>
                        <td>{{ goalie["TOI"]|calc_toi }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

        </div>
    </div>
    {% with team=away, teamname=gamedata.awayteam %}
        {% include "game/playertable.html" %}
    {% endwith %}
    {% with team=home, teamname=gamedata.hometeam %}
        {% include "game/playertable.html" %}
    {% endwith %}
</div>
<div id="event-charts" class="tab-pane fade">
    <h3>Running Shot Attempts</h3>
    <p>Create data retrieval function to pass data out from Flask<br>
        Use Kevin's chart</p>
    <h3>Running Scoring Chance</h3>
    <p>Use same data retrieval function as above with different parameters, Kevin's chart</p>
    <h3>Shot Attempt Charts</h3>
    <div class="row">
        <div class="col-md-6" id="shHome"></div>
        <div class="col-md-6" id="shAway"></div>
    </div>
    <h3>Player Corsi Events</h3>
    <div class="row">
        <div class="col-md-6" id="corsi-home"></div>
        <div class="col-md-6" id="corsi-away"></div>
    </div>
</div>
<div id="player-usage" class="tab-pane fade">
    <h3>Matchup Charts</h3>
    <p>Create data retreival function from coplayer table. Use current WOI or Kevin's -- Group can decide.</p>
    <h3>Line Charts</h3>
    <p>Create data retrieval function from Manny's data.<br>
        Kevin's visualization.</p>
    <h3>Shift Charts</h3>
    <p>Create data retrieval function -- From what data?
        We could use actual shift data from NHL, if we wanted, instead of interpolated.<br>
    Kevin's viz.</p>
</div>
{#                <div id="win-probs" class="tab-pane fade">#}
{#                    <p>Win probabilities</p>#}
{#                </div>#}

{% block page_js %}
<script type="text/javascript">
var margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = ($("#event-tables").width() - margin.left) / 2,
    height = width;

/* 
 * value accessor - returns the value to encode for a given data object.
 * scale - maps value to a visual display encoding, such as a pixel position.
 * map function - maps from data value to display value
 * axis - sets up axis
 */ 

// setup x 
var xValue = function(d) { return d.CF + d.CA;}, // data -> value
    xScale = d3.scale.linear().range([0, width]), // value -> display
    xMap = function(d) { return xScale(xValue(d));}, // data -> display
    xAxis = d3.svg.axis().scale(xScale).orient("bottom");

// setup y
var yValue = function(d) { return d.CF - d.CA;}, // data -> value
    yScale = d3.scale.linear().range([height, 0]), // value -> display
    yMap = function(d) { return yScale(yValue(d));}, // data -> display
    yAxis = d3.svg.axis().scale(yScale).orient("left");

// setup fill color
var cValue = function(d) { return "black";},
    color = d3.scale.category10();

// add the tooltip area to the webpage
var tooltip = d3.select("body")
    .append("div")
    .style("position", "absolute")
    .style("z-index", "10")
    .style("visibility", "hidden")
    .style("border-radius", 3)
    .attr("class", "tooltip-inner")
    .text("a simple tooltip");

{% if homecorsi|length > 0 %}
create_corsi_events({{ homecorsi|safe }}, "#corsi-home", "{{ homecorsi[0].Team|teamname }}");
{% endif %}
{% if awaycorsi|length > 0 %}
create_corsi_events({{ awaycorsi|safe }}, "#corsi-away", "{{ awaycorsi[0].Team|teamname }}");
{% endif %}

// load data
function create_corsi_events(data, divid, teamname) {
    // add the graph canvas to the body of the webpage
    var svg = d3.select(divid).append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  // don't want dots overlapping axis, so add in buffer to data domain
  xScale.domain([d3.min([0, d3.min(data, xValue)-1]), d3.max(data, xValue)+1]);
  yScale.domain([-d3.max(data, function(d) { return Math.abs(d.CF - d.CA); }), d3.max(data,  function(d) { return Math.abs(d.CF - d.CA); })-1]);

  // x-axis
  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
    .append("text")
      .attr("class", "label")
      .attr("x", width)
      .attr("y", -6)
      .style("text-anchor", "end")
      .text("Corsi For Plus Corsi Against");

  // y-axis
  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("class", "label")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Corsi For Minus Corsi Against");


  function format_toi(t) {
    var minutes = Math.floor(t / 60);
    var seconds = t - minutes * 60;
    return minutes + ":" + seconds
  }

    svg.append("text")
        .attr("x", margin.left)
        .attr("y", height - margin.bottom)
        .attr("text-anchor", "left")
        .style("font-size", "12px")
        .text("war-on-ice.com")

    svg.append("text")
        .attr("x", (width / 2))             
        .attr("y", 0 - (margin.top / 4))
        .attr("text-anchor", "middle")  
        .style("font-size", "16px") 
        .style("text-decoration", "underline")  
        .text(teamname + " On-Ice Shot Attempts For/Against");
  // draw dots
  svg.selectAll(".dot")
      .data(data)
    .enter().append("circle")
      .attr("class", "dot")
      .attr("r", 3.5)
      .attr("cx", xMap)
      .attr("cy", yMap)
      .style("fill", function(d) { return get_team_color(d.Team, true); })
      .style("stroke", function(d) { return get_team_color(d.Team, false); })
      .on("mouseover", mouseover)
      .on("mousemove", function(){return tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");})
      .on("mouseout", mouseout);

    function mouseover(p) {
        tooltip.html(p["full_name"] + "<br />SF:" + p.SF + "<br />SA:" + p.SA + "<br />TOI:" + format_toi(p.TOI));
        tooltip.style("visibility", "visible")
    }

    function mouseout() {
        d3.selectAll("text").classed("active", false);
        tooltip.style("visibility", "hidden");
    }

    // Draw Lines
    svg.append("line")          // attach a line
        .style("stroke", "red")  // colour the line
        .attr("x1", xScale(d3.min([0, d3.min(data, xValue)-1])))     // x position of the first end of the line
        .attr("y1", yScale(0))      // y position of the first end of the line
        .attr("x2", xScale(d3.max(data, xValue)+1))     // x position of the second end of the line
        .attr("y2", yScale(0));    // y position of the second end of the line

    var guideLines = [0.5, 1, 2, 4];
    for (var i = 0; i<guideLines.length; i++) {
        svg.append("line")          // attach a line
            .style("stroke", "grey")  // colour the line
            .attr("x1", xScale(d3.min([0, d3.min(data, xValue)-1])))     // x position of the first end of the line
            .attr("y1", yScale(0))      // y position of the first end of the line
            .attr("x2", xScale(guideLines[i] * d3.max(data, function(d) { return Math.abs(d.CF - d.CA); })))     // x position of the second end of the line
            .attr("y2", yScale(-d3.max(data, function(d) { return Math.abs(d.CF - d.CA); })));    // y position of the second end of the line

        svg.append("line")          // attach a line
            .style("stroke", "grey")  // colour the line
            .attr("x1", xScale(d3.min([0, d3.min(data, xValue)-1])))     // x position of the first end of the line
            .attr("y1", yScale(0))      // y position of the first end of the line
            .attr("x2", xScale(guideLines[i] * d3.max(data, function(d) { return Math.abs(d.CF - d.CA); })))     // x position of the second end of the line
            .attr("y2", yScale(d3.max(data, function(d) { return Math.abs(d.CF - d.CA); })));    // y position of the second end of the line
    }

}
</script>
<script type="text/javascript">

createRink("#shHome", {{ pbphome|safe }});
createRink("#shAway", {{ pbpaway|safe }});

function createRink(dividelement, data) {

    var parent = d3.select(dividelement).append("svg");

    var homeRink = RINK_MAP({parent: parent, desiredWidth: 380, data: data, horizontal: false, fullRink: false,
        toolTipValue: RINK_HELPERS.toolTipText});
    homeRink();
}
</script>
{% endblock %}